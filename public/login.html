<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add User</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="container" id="logindiv">
      <img
        src="https://scontent.fccu13-1.fna.fbcdn.net/v/t1.6435-9/203630723_4208177012558379_2015073646230031689_n.png?_nc_cat=103&ccb=1-7&_nc_sid=09cbfe&_nc_ohc=4rmT3cSvx74AX9RSON2&_nc_ht=scontent.fccu13-1.fna&oh=00_AT-0GI906oTKY8Apmv_eXw1f7mSSJOyHv8vJh6p7CI1s0Q&oe=631558C6"
        alt="logo"
      />
      <div class="container2">
        <input
          class="form-control"
          style="margin: 0.6vw"
          type="email"
          id="email"
          placeholder="Email"
        />
        <input
          class="form-control"
          style="margin: 0.6vw"
          type="password"
          id="pass"
          placeholder="Password"
        />

        <button type="submit" class="action_btn btn btn-primary" id="login">
          Login
        </button>
      </div>
    </div>

    <div class="container" id="userdiv">
      <img
        src="https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png"
        alt="logo"
      />
      <h1 id="useremail" style="font-size: 4vw; padding: 3vw">Welcome User!</h1>
      <div class="container2">
        <input
          class="form-control"
          style="margin: 0.6vw"
          type="text"
          id="name"
          placeholder="Name"
        />
      <div class="container2">
        <input
          class="form-control"
          style="margin: 0.6vw"
          type="text"
          id="id"
          placeholder="ID"
        />
        <input
          class="form-control"
          type="text"
          style="margin: 0.6vw"
          id="code"
          placeholder="Coupon Code"
        />
        <button class="btn" style="margin: 0.6vw" type="submit" id="add">
          Add
        </button>
        <button class="btn" type="submit" id="logout">Logout</button>
      </div>
    </div>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-app.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      import {
        getAuth,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-auth.js";

      import {
        getFirestore,
        collection,
        getDoc,
        doc,
        deleteDoc,
        updateDoc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-firestore.js";
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCStgNL0zhOcQDudbYGUiysfTZZX1EfHGo",
        authDomain: "winnerauthenticationgfg.firebaseapp.com",
        projectId: "winnerauthenticationgfg",
        storageBucket: "winnerauthenticationgfg.appspot.com",
        messagingSenderId: "1099077842043",
        appId: "1:1099077842043:web:07e97daa9abe1961395ede",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);

      const auth = getAuth();

      //User logged in or not check
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // User is signed in, see docs for a list of available properties
          document.getElementById("userdiv").style.display = "flex";
          document.getElementById("logindiv").style.display = "none";

          //Check the logged in user

          var user = auth.currentUser;
          console.log(user);
          if (user != null) {
            var email_id = user.email;
            // console.log("Welcome : " + email_id);
            document.getElementById("useremail").innerHTML =
              "Welcome : " + email_id;
          }
          // ...
        } else {
          // User is signed out
          document.getElementById("userdiv").style.display = "none";
          document.getElementById("logindiv").style.display = "flex";
          // ...
        }
      });

      //Logging in the user with email address and password
      async function loginUser() {
        const email = document.getElementById("email").value;
        console.log(email);
        const password = document.getElementById("pass").value;
        signInWithEmailAndPassword(auth, email, password)
          .then((userCredential) => {
            // Signed in
            const user = userCredential.user;
            alert("You have successfully logged in!");
            // window.open("adduser.html", "_self");

            // ...
          })
          .catch((error) => {
            const errorCode = error.code;
            const errorMessage = error.message;
            alert("Error signing in!");
            // window.open("index.html", "_self");
          });
      }

      //Logging out the user
      async function logoutUser() {
        const auth = getAuth();
        signOut(auth)
          .then(() => {
            // Sign-out successful.
            alert("Logged out successfully!");
            location.reload(); //reload the current page
          })
          .catch((error) => {
            // An error happened.
            alert("An error occurred!");
          });
      }

      // Initialize Firebase
      const db = getFirestore();

      //adding userdata in firestore database
      async function addUser() {
        const id = document.getElementById("id").value;
        const code = document.getElementById("code").value;
        const name = document.getElementById("name").value;

        var colRef = doc(db, "coupons", id);
        const docSnap = await getDoc(colRef);
        console.log(id);

        if (!docSnap.exists()) {
          //add user doesnot exist
          //Adding time stamp and changing status
          let timeStamp = Date.now();
          await setDoc(doc(db, "coupons", id), {
            status: true,
            time: new Date(timeStamp),
            id: id,
            code: code,
            name:name,
          });
          alert("User added successfully");
          location.reload();
        } else {
          alert("User is already added!");
        }
      }

      document.getElementById("login").addEventListener("click", loginUser);
      document.getElementById("logout").addEventListener("click", logoutUser);
      document.getElementById("add").addEventListener("click", addUser);
    </script>
  </body>
</html>
